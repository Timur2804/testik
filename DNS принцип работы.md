# DNS — принципы работы DNS и инструменты работы с ним

## Иерархическая структура доменных имён
Иерархия организована как *перевёрнутое дерево* (домены справа налево, разделены точками). На вершине — **корневой домен** (точка), затем **TLD** (например, `.com`, `.org`), далее — поддомены более низких уровней (например, `yandex.ru`, `pogoda.yandex.ru`).

```text
. (корень)
├─ com
│  ├─ example.com
│  └─ google.com
└─ ru
   └─ yandex.ru
```

## Навигация по иерархии
- **Корневые серверы → верхний уровень (`.`)**
- **TLD (Top Level Domain)** → `.com`, `.ru`, `.org`
- **Домены второго уровня** → `example.com`, `yandex.ru`
- **Поддомены** → `mail.example.com`

## Как и где приобрести доменное имя?
Зарегистрировать домен можно у аккредитованного регистратора (например, Nic.ru): ввести желаемое имя, проверить доступность и оплатить регистрацию на срок.

## Рекурсивный vs итеративный DNS‑запрос
1. **Рекурсивный** — клиент просит *готовый ответ*; рекурсивный резолвер сам обходит `root → TLD → авторитетные NS` и возвращает результат (часто из кэша).  
   **Кто:** публичные/провайдерские/корпоративные DNS (8.8.8.8, 1.1.1.1). **Когда:** обычные запросы приложений.
2. **Итеративный** — на каждом шаге сервер отвечает «спроси там‑то» (даёт NS следующего уровня), не доводя поиск до конца.  
   **Кто:** DNS‑серверы между собой, диагностика (`dig +trace`). **Когда:** разбор делегирования, отладка.

## Что такое TTL в DNS?
**TTL (Time To Live)** — время в секундах, сколько ответ можно держать в кэше резолверов и ОС. Пока TTL не истёк, клиенты видят старое значение; «распространение» изменений по сути равно сроку кэширования.

## Основные типы записей
- **A / AAAA** — IPv4 / IPv6‑адрес.  
- **CNAME** — алиас имени на другое имя.  
- **NS** — авторитетные DNS‑серверы зоны.  
- **MX** — почтовые серверы домена.  
- **TXT** — произвольный текст (SPF, DKIM, DMARC, верификации).  
- **SOA** — параметры зоны (serial, таймеры, админ).  
- **SRV** — сервис + порт (например, `_sip._tcp`).  
- **PTR** — обратное сопоставление IP → имя.  
- **CAA** — разрешённые центры сертификации для TLS‑сертификатов.  
- **NAPTR/…** — спец. маршрутизация/VoIP и пр. (реже).

## Разница между A и CNAME
**A:** привязывает *имя → IPv4* (для IPv6 — **AAAA**).  
Пример: `www.example.com A 203.0.113.10`.

**CNAME:** делает *алиас имя → другое имя*; итоговый IP берётся у целевого имени.  
Пример: `www.example.com CNAME app.hosted.net.` → далее резолв `app.hosted.net` до A/AAAA.

**Правила:**
- У одного и того же имени нельзя иметь **CNAME** и другие записи (A/MX/TXT/…).  
- На **апексе** зоны (`example.com.`) классический CNAME запрещён; используют A/AAAA или провайдерские псевдо‑алиасы (**ALIAS/ANAME**).  
- **CNAME не делает HTTP‑редирект** — это только DNS‑алиас; перенаправление настраивается на уровне веб‑сервера/HTTP.

## Две A‑записи у домена — какую получит клиент?
Авторитетный DNS вернёт обе записи. Клиент обычно берёт первую в ответе (порядок нередко перемешивается сервером — простейший *DNS round‑robin*). Если выбранный адрес не отвечает, многие стеки пробуют следующий. Итог зависит от кэша и порядка, который выдал резолвер.

## Сколько ждать после изменения A‑записей?
До истечения **TTL** старых ответов у кэширующих резолверов и в ОС/браузере. Если TTL был `3600`, обновление «дойдёт» примерно за **1 час**.  
На авторитетном DNS изменения применяются сразу, но клиенты увидят их, когда кэш «протухнет».

**Зависит от:**
- текущего TTL (включая *negative TTL* из SOA),  
- кэша ОС/браузера,  
- политик резолверов/провайдеров (минимумы/максимумы TTL, иногда *stale‑if‑error*).

**Практика миграций:** за 24–48 часов снизьте TTL (до 60–300 с), дождитесь обновления, выполните смену, затем верните TTL выше. Локально можно очистить кэш DNS и проверить через разные публичные резолверы (1.1.1.1, 8.8.8.8).

## Ошибки при отсутствии A‑записи
- Если домен существует, но нет A/AAAA (**NOERROR/NODATA**):  
  **Браузер:** обычно `ERR_NAME_NOT_RESOLVED`.  
  **curl:** `curl: (6) Could not resolve host: example.com` (код 6).
- Если домена/зоны нет (**NXDOMAIN**):  
  **Браузер:** часто `DNS_PROBE_FINISHED_NXDOMAIN` (или также `ERR_NAME_NOT_RESOLVED`).  
  **curl:** тот же код 6.

## Как посмотреть A-запись:
- `ping domain` - резолвит имя и пишет, куда шлет ICMP
- `curl -v domain` - в выводе видно строки вида * Trying 203.0.113.10:443... - это IP подключения 
- `dig a domain.ru` vs `dig +trace domain.ru`
- `dig a domain.ru` — спрашивает настроенный рекурсивный резолвер нужную A‑запись (ответ может быть из кэша).  
- `dig +trace domain.ru` — итеративный обход от корня: `root → TLD → авторитетные NS` и финальный ответ, без участия локального кэша. Удобно для диагностики делегирования.

## Быстрые проверки (Linux/macOS)
```bash
dig +short example.com
dig A example.com @1.1.1.1 +ttlunits
host example.com
nslookup example.com
```

## Windows / PowerShell
```powershell
Resolve-DnsName example.com -Type A
Resolve-DnsName example.com -Server 1.1.1.1
```
```
nslookup example.co -  спросит у системного DNS-сервера A/AAAA записи
```

## IPv6 и другие типы
```bash
dig AAAA example.com +short
dig MX example.com +short
```

## Как спросить конкретный DNS‑сервер
**Linux/macOS (`dig`)**
```bash
# A‑запись у конкретного резолвера (Cloudflare)
dig A example.com @1.1.1.1 +ttlunits

# TXT‑запись у Google DNS
dig TXT example.com @8.8.8.8 +short

# Спросить напрямую авторитетный NS (без рекурсии)
dig A example.com @ns1.example.com +norecurse

# Нестандартный порт
dig A example.com @1.2.3.4 -p 5353
```

**Windows**
```powershell
Resolve-DnsName example.com -Type A -Server 1.1.1.1
Resolve-DnsName example.com -Type TXT -Server 8.8.8.8
```

```text

# Структура запроса
[Наш сервер]  -->                             [Рекурсивный DNS-провайдера]
       |                                                   |
       |                                   (не знаешь IP?) |
       |                                                   |
       |                                                   |
       |                                                   v
       |                                           [Root-сервер (.)]
       |                                                   |
       |                               (=> отвечает, какой TLD сервер нужен (.com))
       |                                                   |
       v                                                   v
[Рекурсивный DNS]                                 [TLD-сервер (.com)]
       |                                                   |
       |          (=> отвечает, какой авторитетный сервер знает example.com)
       |                                                   |
       |                                                   |
        - - - - > [Авторитетный DNS-сервер example.com] < -  
                                 |
                                 | (=> возвращает IP: 93.184.216.34)
                                 |
                                 v
                    [Рекурсивный DNS-провайдера] => возвращает IP твоему серверу
                                 |
                                 v
                            [Наш сервер] => открывает сайт по IP

```

#### Разбор:

**Наш сервер (клиент) спрашивает у ближайшего рекурсивного DNS**
**Рекурсивный DNS проверяет кэш. Если нет — идёт к root**
**Root-сервер => отвечает на вопрос: «к какому TLD обратиться?»**
**TLD-сервер => отвечает: «авторитетный сервер домена здесь»**
**Авторитетный сервер => даёт IP для домена**
**Рекурсивный сервер => возвращает IP клиенту**
**Твой сервер => подключается к сайту**
